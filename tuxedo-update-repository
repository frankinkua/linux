#!/bin/bash

set -ex

MAINLINE_KERNEL_VERSION=6.5
UBUNTU_TAG_VERSION_PREFIX=Ubuntu-hwe-${MAINLINE_KERNEL_VERSION}-
TUXEDO_TAG_VERSION_PREFIX=Ubuntu-tuxedo-${MAINLINE_KERNEL_VERSION}-

echo "===Starting repository update.==="

SCRIPT=$(realpath "$0")
SCRIPTPATH=$(dirname "${SCRIPT}")
cd "${SCRIPTPATH}"

if [ -f debian/debian.env ]; then
	# shellcheck disable=SC1091
	. debian/debian.env
fi

if [ ! -d "${DEBIAN}" ]; then
	echo Abstracted debian directory does not exist or is not set.
	exit 1
fi

CONF="${DEBIAN}"/etc/update.conf
if [ -f "${CONF}" ]; then
	# shellcheck disable=SC1090
	. "${CONF}"
fi

echo "===Fetching newest version from upstream.==="

if git remote | grep release_repo; then
    git remote set-url release_repo ${RELEASE_REPO}
else
    git remote add release_repo ${RELEASE_REPO}
fi
git fetch release_repo --tags

CURRENT_BASE_VERSION_TAG=$(git describe --tags --abbrev=0 --match "${UBUNTU_TAG_VERSION_PREFIX}*" --exclude "${TUXEDO_TAG_VERSION_PREFIX}*")
CURRENT_BASE_VERSION_TAG_NUMBER=$(echo ${CURRENT_BASE_VERSION_TAG} | grep -Po "(?<=^${UBUNTU_TAG_VERSION_PREFIX}).*(?=$)")
CURRENT_BASE_VERSION_NUMBER=${CURRENT_BASE_VERSION_TAG_NUMBER//_/\~}

NEWEST_VERSION_TAG=$(git describe --tags --abbrev=0 release_repo/${SOURCE_RELEASE_BRANCH})
NEWEST_VERSION_TAG_NUMBER=$(echo ${NEWEST_VERSION_TAG} | grep -Po "(?<=^${UBUNTU_TAG_VERSION_PREFIX}).*(?=$)")
NEWEST_VERSION_NUMBER=${NEWEST_VERSION_TAG_NUMBER//_/\~}

if [ ${CURRENT_BASE_VERSION_NUMBER} = ${NEWEST_VERSION_NUMBER} ]; then
    echo "===Version already up to date. Exiting.==="
    exit
fi

echo "===Start package update.==="

if git remote | grep torvalds; then
    git remote set-url torvalds git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
else
    git remote add torvalds git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
fi
git fetch torvalds --tags

echo "===Checking out correct Ubuntu kernel.==="
./debian/scripts/helpers/rebase

echo "===Done.==="

if [ $# -eq 1 ] && [ $1 = "auto-update" ]; then
    CRANKY_MAILENFORCE="*" ./debian/scripts/helpers/open

    ./${DEBIAN}/scripts/helpers/copy-files

    LANG=C fakeroot debian/rules updateconfigs || true
    LANG=C fakeroot debian/rules updateconfigs

    ./debian/scripts/helpers/close --include-config

    TUX_VERSION_NUMBER=$(grep -Pom1 "(?<=^linux-tuxedo-${MAINLINE_KERNEL_VERSION} \().*(?=\))" ${DEBIAN}/changelog)
    git tag -s -m "${TUXEDO_TAG_VERSION_PREFIX}${TUX_VERSION_NUMBER}" "${TUXEDO_TAG_VERSION_PREFIX}${TUX_VERSION_NUMBER}"
else
    echo "Run 'CRANKY_MAILENFORCE="*" ./debian/scripts/helpers/open' and './debian/scripts/helpers/close' next."
fi
