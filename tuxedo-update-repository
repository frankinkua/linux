#!/bin/bash

set -ex

UBUNTU_CODENAME=jammy
MAINLINE_KERNEL_VERSION=6.0
UBUNTU_KERNEL_BRANCH_NEXT=oem-${MAINLINE_KERNEL_VERSION}-next
TUXEDO_KERNEL_BRANCH=tuxedo-${MAINLINE_KERNEL_VERSION}-22.04

echo "===Starting repository update.==="

SCRIPT=$(realpath "$0")
SCRIPTPATH=$(dirname "${SCRIPT}")
cd "${SCRIPTPATH}"

echo "===Fetching newest version from upstream.==="

if git remote | grep ubuntu-oem-${UBUNTU_CODENAME}; then
    git remote set-url ubuntu-oem-${UBUNTU_CODENAME} git://git.launchpad.net/~canonical-kernel/ubuntu/+source/linux-oem/+git/${UBUNTU_CODENAME}
else
    git remote add ubuntu-oem-${UBUNTU_CODENAME} git://git.launchpad.net/~canonical-kernel/ubuntu/+source/linux-oem/+git/${UBUNTU_CODENAME}
fi
git fetch ubuntu-oem-${UBUNTU_CODENAME} --tags

CURRENT_BASE_VERSION_TAG=$(git describe --tags --abbrev=0 --match "Ubuntu-oem-*")
CURRENT_BASE_VERSION_TAG_NUMBER=$(echo ${CURRENT_BASE_VERSION_TAG} | grep -Po "(?<=^Ubuntu-oem-).*(?=$)")
CURRENT_BASE_VERSION_NUMBER=${CURRENT_BASE_VERSION_TAG_NUMBER//_/\~}

NEWEST_VERSION_TAG=$(git describe --tags ubuntu-oem-${UBUNTU_CODENAME}/${UBUNTU_KERNEL_BRANCH_NEXT} --abbrev=0)
NEWEST_VERSION_TAG_NUMBER=$(echo ${NEWEST_VERSION_TAG} | grep -Po "(?<=^Ubuntu-oem-).*(?=$)")
NEWEST_VERSION_NUMBER=${NEWEST_VERSION_TAG_NUMBER//_/\~}

if [ ${CURRENT_BASE_VERSION_NUMBER} = ${NEWEST_VERSION_NUMBER} ]; then
    echo "===Version already up to date. Exiting.==="
    exit
fi

echo "===Start package update.==="

echo "===Checking out correct Ubuntu kernel.==="
./debian/scripts/helpers/rebase

echo "===Done.==="

if [ $# -eq 1 ] && [ $1 = "auto-update" ]; then
    CRANKY_MAILENFORCE="*" ./debian/scripts/helpers/open
    ./debian/scripts/helpers/close --include-config
    TUX_VERSION_PREFIX=Ubuntu-tuxedo-${MAINLINE_KERNEL_VERSION}-
    TUX_VERSION_NUMBER=$(grep -Pom1 "(?<=^linux-tuxedo-${MAINLINE_KERNEL_VERSION} \().*(?=\))" debian.tuxedo-${MAINLINE_KERNEL_VERSION}/changelog)
    git tag -s -m "${TUX_VERSION_PREFIX}${TUX_VERSION_NUMBER}" "${TUX_VERSION_PREFIX}${TUX_VERSION_NUMBER//\~/_}"
else
    echo "Run 'CRANKY_MAILENFORCE="*" ./debian/scripts/helpers/open' and './debian/scripts/helpers/close' next."
fi
